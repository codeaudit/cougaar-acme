####################################################
# Rule to insert SDRegistrationPlugin and SDClientPlugin
#   at every agent so providers can register and customers can find providers
#
# 1. plugin = org.cougaar.servicediscovery.service.UDDI4JRegistrationServiceComponent
# 2. plugin = org.cougaar.servicediscovery.service.UDDI4JRegistryQueryServiceComponent
# 3. plugin = org.cougaar.servicediscovery.plugin.LineagePlugin
# 4. plugin = org.cougaar.servicediscovery.plugin.SDRegistrationPlugin
# 5. plugin = org.cougaar.servicediscovery.servlet.MatchMakerQueryServletComponent(org.cougaar.servicediscovery.servlet.MatchMakerQueryServlet,/matchmaker_query)
# 6. plugin = org.cougaar.servicediscovery.plugin.SDClientPlugin(NeededRole,NeededRole,...)
# 7. plugin = org.cougaar.servicediscovery.plugin.MatchmakerStubPlugin
# 8. plugin = org.cougaar.servicediscovery.plugin.SDProviderPlugin(ProvidedRole,ProvidedRole,...)
#
# Roles
# AmmunitionProvider
# FuelSupplyProvider
# PackagedPOLSupplyProvider
# SparePartsProvider
# SubsistenceSupplyProvider
#
uddi4j_registration_service = "org.cougaar.servicediscovery.service.UDDI4JRegistrationServiceComponent"
uddi4j_registry_query_service = "org.cougaar.servicediscovery.service.UDDI4JRegistryQueryServiceComponent"
lineage_plugin = "org.cougaar.servicediscovery.plugin.LineagePlugin"
sd_registration_plugin = "org.cougaar.servicediscovery.plugin.SDRegistrationPlugin"
matchmaker_query_servlet_component = "org.cougaar.servicediscovery.servlet.MatchMakerQueryServletComponent"
matchmaker_query_servlet = "org.cougaar.servicediscovery.servlet.MatchMakerQueryServlet"
sd_client_plugin = "org.cougaar.servicediscovery.plugin.SDClientPlugin"
matchmaker_stub_plugin = "org.cougaar.servicediscovery.plugin.MatchmakerStubPlugin"
sd_provider_plugin = "org.cougaar.servicediscovery.plugin.SDProviderPlugin"

supply_roles = Array ["AmmunitionProvider",
                      "FuelSupplyProvider",
                      "PackagedPOLSupplyProvider",
                      "SparePartsProvider",
                      "SubsistenceSupplyProvider"]
strat_trans_role = "StrategicTransportationProvider"                      

def get_superior_sca(agent, supported_orgs)
  if agent.has_facet?(:superior_org_id)
    sup_name = agent.get_facet(:superior_org_id)
    # puts "Agent name is: " +agent.name + " and superior name is: "+sup_name
    superior = society.agents[sup_name]
    unless superior == nil
      superior.each_facet(:sca_supported_org) do |facet|
	supported_org = facet[:sca_supported_org].to_s    
	unless supported_orgs.include?(supported_org)
          supported_orgs.push(supported_org)
	end
      end
      get_superior_sca(superior, supported_orgs)
    end
  end    
end

# First iterate over agents, collecting the provided_roles, mechanisms, and echelons of support
society.each_agent do |agent|
  provided_roles = Hash.new
  agent.each_facet(:role) do |facet|
    my_role = facet[:role].to_s
    my_mechanism = facet[:mechanism].to_s
    my_echelon_of_support= facet[:echelon_of_support].to_s
    provided_roles[my_role] = [my_mechanism,my_echelon_of_support]
  end
#
# Then get the required_roles
  required_roles = Array.new
#
# Add each provided_role if it is a supply_role, unless the mechanism is "TerminalInventoryManager"
# or if it is the strat_trans_role with a mechanism of "PassThrough"
  provided_roles.each do |my_role, m_e| 
    if supply_roles.include?(my_role) && (m_e[0] != "TerminalInventoryManager" && m_e[0] != "TerminalAmmunitionPacker")
      unless agent.has_facet? { |facet| facet[:role]=='FuelSupplyProvider' && (facet[:mechanism] == 'TruckScheduler') }      
	required_roles << my_role
      end
    end
    if my_role == strat_trans_role && m_e[0] == "PassThrough"
      required_roles << my_role
    end
  end
# Add the required supply roles if the org has equipment_assets
  if agent.get_facet(:has_equipment_assets)
    unless agent.get_facet(:is_ua)
      required_roles << "AmmunitionProvider"
      required_roles << "FuelSupplyProvider"
      required_roles << "PackagedPOLSupplyProvider"
      required_roles << "SparePartsProvider"
    end
  end
#
# Add the required supply role if the org has personnel_assets
  if agent.get_facet(:has_personnel_assets)
    unless agent.get_facet(:is_ua)
      required_roles << "SubsistenceSupplyProvider"
    end
  end
#
# Add the required supply role if the org is a UA agent
  if agent.get_facet(:is_ua)
    unless agent.has_facet? { |facet| facet[:role]=='FuelSupplyProvider' && (facet[:mechanism] == 'TruckScheduler') }      
      required_roles << "FuelSupplyProvider" 
    end
  end
#
# Add the required strat_trans_role if the agent is deployable with either equipment or personnel
  if agent.get_facet(:has_personnel_assets) || agent.get_facet(:has_equipment_assets)
    if agent.get_facet(:is_deployable)
      required_roles << strat_trans_role
    end
  end
#
# Add the strat_trans_role to the OSC Agent.
# (Role == "AmmunitionProvider" && Mechanism=="TerminalAmmunitionPacker")
  provided_roles.each do |my_role, m_e| 
    if my_role == "AmmunitionProvider" && m_e[0] == "TerminalAmmunitionPacker"
      required_roles << strat_trans_role
    end
  end
#
# Add the required roles for the Transcom Community
  if agent.get_facet(:echelon_group) == "Transcom"
    provided_roles.each do |my_role, m_e|
#
# TRANSCOM-7 needs AirTransportationProvider
# TRANSCOM-7 needs SeaTransportationProvider
      if my_role == strat_trans_role && m_e[0] == "ModeSelector"   # That makes this org TRANSCOM-7
        required_roles << "AirTransportationProvider"
        required_roles << "SeaTransportationProvider"
      end
#
# GlobalAir needs ToPOEGroundTransportationProvider
# GlobalAir needs OrganicAirTransportationprovider
# GlobalAir needs FromPODGroundTransportationProvider
      if my_role == "AirTransportationProvider"  && m_e[0]=="Global"                 # That makes this org GlobalAir
        required_roles << "ToPOEGroundTransportationProvider"
        required_roles << "OrganicAirTransportationProvider"
        required_roles << "FromPODGroundTransportationProvider"
      end
#
# ConusAir,EuroAir needs ToPOEGroundTransportationProvider
# ConusAir,EuroAir needs OrganicAirTransportationprovider
# ConusAir,EuroAir needs FromPODGroundTransportationProvider
      if my_role == "AirTransportationProvider"  && (m_e[0]=="Euro" || m_e[0]=="Conus")    # That makes this org EuroAir, or ConusAir
        required_roles << "ToPOEGroundTransportationProvider"
        required_roles << "OrganicAirTransportationProvider:2"
        required_roles << "FromPODGroundTransportationProvider:2"
      end
#
# GlobalSea needs ToPOEGroundTransportationProvider
# GlobalSea needs ShipPackingTransportationProvider
# GlobalSea needs FromPODGroundTransportationProvider
      if my_role == "SeaTransportationProvider" && (m_e[0]=="Global" || m_e[0]=="Ammo")     # That makes this org GlobalSea or AmmoSea
        required_roles << "ToPOEGroundTransportationProvider"
        required_roles << "ShipPackingTransportationProvider"
        required_roles << "FromPODGroundTransportationProvider"
      end
#
# EuroSea or ConusSea needs ToPOEGroundTransportationProvider
# EuroSea or ConusSea needs ShipPackingTransportationProvider
# EuroSea or ConusSea needs FromPODGroundTransportationProvider
      if my_role == "SeaTransportationProvider" && (m_e[0]=="Euro" || m_e[0]=="Conus")    # That makes this org EuroSea or ConusSea
        required_roles << "ToPOEGroundTransportationProvider"
        required_roles << "ShipPackingTransportationProvider"
        required_roles << "FromPODGroundTransportationProvider:2"
      end
#
# TRANSCOM-20 needs EuroStrategicTransportationProvider
# TRANSCOM-20 needs ConusStrategicTransportationProvider
# TRANSCOM-20 needs AmmoStrategicTransportationProvider
      if my_role == strat_trans_role && m_e[0] == "TaskSorter"    # That makes this org TRANSCOM-20
        required_roles << "EuroStrategicTransportationProvider"
        required_roles << "ConusStrategicTransportationProvider"
        required_roles << "AmmoStrategicTransportationProvider"
      end
#
# EuroTRANSCOM needs AirTransportationProvider
# EuroTRANSCOM needs SeaTransportationProvider
      if my_role == "EuroStrategicTransportationProvider" || my_role == "ConusStrategicTransportationProvider" 
                                                                  # That makes this org EuroTRANSCOM or ConusTRANSCOM
        required_roles << "AirTransportationProvider"
        required_roles << "SeaTransportationProvider"
      end
#
# AmmoTRANSCOM needs SeaTransportationProvider
      if my_role == "AmmoStrategicTransportationProvider"         # That makes this org AmmoTRANSCOM
        required_roles << "SeaTransportationProvider"
      end
#
    end
  end
#
# sort and get rid of duplicated required_roles, if any
  required_roles = required_roles.sort
  required_roles = required_roles.uniq 
#
# Then insert the UDDI4JRegistrationService, UDDI4JRegistryQueryService with no arguments
# Load these UDDI4J plugins early and with Binder priority so SDReg Plugin can always find them
  agent.add_component do |c|
    c.classname = uddi4j_registration_service
  end
  agent.add_component do |c|
    c.classname = uddi4j_registry_query_service
  end
#
# Then insert the LineagePlugin with no arguments
  agent.add_component do |c|
    c.classname = lineage_plugin
  end

# Insert the SDRegistrationPlugin with the number of sca's as an argument.
  agent.add_component do |c|
    # Calculated all of the sca's
    # First calculate my local count of sca's
    supported_orgs = Array.new
    agent.each_facet(:sca_supported_org) do |facet|
      supported_org = facet[:sca_supported_org].to_s  
      # puts "For agent: "+agent.name + " own sca_supported_org: " +supported_org
      unless supported_orgs.include?(supported_org)
	supported_orgs.push(supported_org)
      end
    end
    # Now insert my Superiors SCA's
    get_superior_sca(agent, supported_orgs)
    c.classname = sd_registration_plugin
    supported_orgs.uniq
    c.add_argument(supported_orgs.length.to_s)
    # puts "Length for agent " +agent.name + "is " +supported_orgs.length.to_s 
  end
#
# Then insert the MatchMakerQueryServletComponent with its arguments
  agent.add_component do |c|
    c.classname = matchmaker_query_servlet_component
    c.add_argument(matchmaker_query_servlet)
    c.add_argument("/matchmaker_query")
  end
#
#
# Then insert the SDClientPlugin with required role arguments
  agent.add_component do |c|
    c.classname = sd_client_plugin
    required_roles.each { |my_role| c.add_argument(my_role) }
    c.priority = "LOW"
  end
#
# Then insert the MatchmakerStubPlugin with no arguments
  agent.add_component do |c|
    c.classname = matchmaker_stub_plugin
  end
#
# Then insert the SDProviderPlugin with Provided roles (although these are presently ignored)
  agent.add_component do |c|
    c.classname = sd_provider_plugin
# Comment out args for now
#   provided_roles.each_key { |my_role| c.add_argument(my_role) }
  end

end
